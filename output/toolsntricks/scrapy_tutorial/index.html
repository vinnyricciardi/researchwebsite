<!DOCTYPE html>
<html lang="en"
>
<head>
    <title>Scrapy - DISHING DATA</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="../../images/favicon.png" rel="icon">

<link rel="canonical" href="../../toolsntricks/scrapy_tutorial/">

        <meta name="author" content="Vinny Ricciardi" />
        <meta name="keywords" content="scraping,webcrawling,toolsntricks" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="../../theme/css/bootstrap.cosmo.min.css" type="text/css"/>
    <link href="../../theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="../../theme/css/pygments/native.css" rel="stylesheet">
        <link href="../../theme/css/typogrify.css" rel="stylesheet">
    <link rel="stylesheet" href="../../theme/css/style.css" type="text/css"/>


</head>
<body>
<script src="../../theme/js/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
    
	    <!--navbar-header-->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="../../" class="navbar-brand">
<img src="../../images/favicon.png" width="20"/>             </a>
        </div>
        
        <!-- Search Box -->
	  
		<!--Menuitems, collapable-->
        <div class="collapse navbar-collapse navbar-ex1-collapse" id="navbar-collapse">
          <ul class="nav navbar-nav" id="menuitem-list">
                  <li >
                    <a href="/aboutme/bio/">About Me</a>
                  </li>

                  <li >
                    <a href="/aboutme/curriculumvitae/">CV</a>
                  </li>

                <li class="btn-group">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown">Research Projects<b class="caret"></b>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li >
                      <a href="/smallholders/Global_production/index.html">Farm Size</a>
                    </li>
                    <li >
                      <a href="/smallholders/RuLIS_Project/index.html">SDG 2.3 - Zero Hunger</a>
                    </li>
                    <li >
                      <a href="/mtnadaptation/Mtn_Adaptation_Project/index.html">Mountain Farming</a>
                    </li>
                    <li >
                      <a href="/landgrabs/Land_Policy_Project/index.html">Land Grabs</a>
                    </li>
                    <li >
                      <a href="/landusepolicy/Land_Use_Policy_Project/index.html">Land Use Policy</a>
                    </li>
                    <li >
                      <a href="/coloursoffoodsecurity/Colours_of_Food_Security/index.html">Colours of Food Security</a>
                    </li>
                  </ul>
                </li>
                  <li >
                    <a href="/category/toolsntricks.html">Tools and Tricks</a>
                  </li>

                  <li >
                    <a href="/news/news/index.html">News</a>
                  </li>

          </ul>
        </div>

<!-- 		<div class="collapse navbar-collapse" id="navbar-collapse">
		  <ul class="nav navbar-nav" id="menuitem-list">
				  <li >
					<a href="/aboutme/bio/">About Me</a>
				  </li>

				  <li >
					<a href="/aboutme/curriculumvitae/">CV</a>
				  </li>

				<li class="btn-group">
				  <a href="#" class="dropdown-toggle" data-toggle="dropdown">Research Projects<b class="caret"></b>
				  </a>
				  <ul class="dropdown-menu" role="menu">
					<li >
					  <a href="/smallholders/Global_production/index.html">Farm Size</a>
					</li>
					<li >
					  <a href="/smallholders/RuLIS_Project/index.html">SDG 2.3 - Zero Hunger</a>
					</li>
					<li >
					  <a href="/mtnadaptation/Mtn_Adaptation_Project/index.html">Mountain Farming</a>
					</li>
					<li >
					  <a href="/landgrabs/Land_Policy_Project/index.html">Land Grabs</a>
					</li>
					<li >
					  <a href="/landusepolicy/Land_Use_Policy_Project/index.html">Land Use Policy</a>
					</li>
					<li >
					  <a href="/coloursoffoodsecurity/Colours_of_Food_Security/index.html">Colours of Food Security</a>
					</li>
				  </ul>
				</li>
				  <li >
					<a href="/category/toolsntricks.html">Tools and Tricks</a>
				  </li>

				  <li >
					<a href="/news/news/index.html">News</a>
				  </li>

		  </ul>
		</div> -->
    </div>
</div> 
<!-- /.navbar -->

<div class="container">
    <div class="row">
<!--                 <div class="col-sm-9">
 -->

    <section id="content">
        <article>
            <div class="entry-content">
                
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1>Scrapy overview<br><br></h1>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The goal of this post is to show you how to use <a href="https://scrapy.org/">Scrapy</a>, a web scraping framework written in Python. Scrapy works by setting up a &#8216;spider&#8217; to &#8216;crawl&#8217; through web&#8230; pages (gotta love a solid program with a punny setup ;) ). We need to specify how we want our spider to crawl through the webpages (what links to follow) and what to pick up along its way (the data that each webpage stores in its html&nbsp;tags).</p>
<p>To demonstrate how to set up a basic scraper, we will scrape all the articles&#8217; publication date, headline title, brief description, and the url link to the actual article from <a href="http://ekurd.net/all-news">EKurd</a>, a site dedicated to independent news on Kurdistan. This task is part of a larger project with friends at the awesome think tank <a href="http://alephpolicy.org/">Aleph Policy Initiative</a> whose goal is to bridge data science and policy in the Middle&nbsp;East.</p>
<p>We&#8217;re going to use Scrapy for this task, because its a simple to use and to implement scraping framework that&#8217;s ripe for iterating through those &#8216;next&#8217; page features in EKurd&#8217;s news&nbsp;archive.</p>
<p>To make this work we use Python 3.5.2, Scrapy 1.4.0, and Pandas&nbsp;0.21.0.</p>
<p>The basic steps to scrape this site are we&#8217;re going to grab the html elements out of the source code using the html tags (such as <code>div</code> tags, <code>h2</code> tags, <code>p</code> tags, and a few more). Then we&#8217;ll store it in a Pandas dataframe, iterate to the next article in the list, store it and so on until we reach the end of the page. Then we&#8217;ll have our spider crawl to the next page and repeat. Once our spider hits the last page, it will output the Pandas dataframe into an easy to analyze&nbsp;csv.</p>
<p>To begin, we&#8217;ll take an in depth look at EKurd&#8217;s news webpage. It contains a list of articles with their publication date, headline title, brief description, and the url link to the actual article. At the bottom of the webpage there are one of those next page navigation buttons (see pic below) that will let you navigate to all 1300+ pages with the same type of&nbsp;information.</p>
<p><img src="{filename}/images/next_nav.png" alt="Drawing" style="width: 700px;"/></p>
<p>That&#8217;s a lot of news! With Scrapy, we automate all this so we can use this data in more interesting ways such as sentiment analysis and other types of text classification (stay tuned for a later&nbsp;post).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><br></p>
<h2>1. Take a look at EKurd&#8217;s source code.<br><br></h2>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Navigate to where Ekurd keeps their <a href="http://ekurd.net/all-news">news archive</a>, right click on the first headline you see and click &#8216;Inspect Element&#8217; if using Firefox - most browsers have a similar feature. See the screenshot below for reference.<br><br></p>
<p><img src="{filename}/images/dev_console.png" alt="Drawing" style="width: 100%;"/></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you look in the development console you can see that each articles&#8217; content (e.g., title, description, date published, and url) are listed under the div tag with the id set as &#8216;Content.&#8217; Here&#8217;s a screen shot of all the articles on this page neatly organized under the content <code>div</code> tag. We can see the first article is the one we right clicked on (note, when you right click on the article and inspect element, it will be expanded - I just wanted to show you the html hierarchy its embedded in).
<br></p>
<p><img src="{filename}/images/div_tag.png" alt="Drawing" style="width: 100%;"/></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We are going to look at the first article in the list to see how it&#8217;s structured. When you right clicked on the article title and opened the development console it should have expanded the article tag for the first article to look like&nbsp;this.</p>
<p><img src="{filename}/images/article_tag.png" alt="Drawing" style="width: 100%;"/></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can see in the very first line under the <code>article</code> tag, the class is an <code>entry-list</code>. This information will come in handy when we set up are scraper because all the data we want to grab is under this <code>article</code> tag. If we keep reading through the code we can see that under the <code>h2</code> tag there is an <code>a</code> tag that contains the article&#8217;s title and url to the actual article (note, the url is listed in many tags so we could grab it from a number of places). We can see in the <code>p</code> tag there is the description of the article and in the <code>aside</code> tag there is the publication&nbsp;date.</p>
<p>To make use of these tags and the data they contain, we will need to tell Scrapy this is where we want our spider to grab data&nbsp;from.</p>
<p>For now, just take note of the location of this data and I&#8217;ll explain how they&#8217;ll fit into our code below more&nbsp;detail.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><br></p>
<h2>2. Writing a spider<br><br></h2>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let&#8217;s build a boilerplate script for our spider. We&#8217;ll first define the variables needed then I&#8217;ll explain how it all is put&nbsp;together.</p>
<p>We have to tell it what website or list of websites we want to&nbsp;scrape:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;http://ekurd.net/all-news&#39;</span><span class="p">]</span>  
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And where to start looking for the data we want to grab. So we use the tags we identified in the source code&nbsp;before:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">TITLE_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;h2 a ::text&#39;</span>        <span class="c1"># This is where the title is stored                         </span>
<span class="n">URL_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;h2 a ::attr(href)&#39;</span>    <span class="c1"># This is where the url to the actual article is stored       </span>
<span class="n">DESCRIP_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;p ::text&#39;</span>         <span class="c1"># This is where the article description is stored           </span>
<span class="n">DATE_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;aside a time::text&#39;</span>  <span class="c1"># This is where the publication date is stored</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since these tags are used throughout the document in many ways, we need to use the article tag class to make sure we&#8217;re in the right section of the source&nbsp;code:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">SET_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;.entry-list&#39;</span>          <span class="c1"># This is the article class all the other tags fall under</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The way this works is the spider will look for the first tag with the class of &#8216;entry-list&#8217;, then for each variable it will look for the subsequent tag. For example, take the <code>TITLE_SELECTOR</code> variable. The spider will look under the first tag with an <code>entry-list</code> then for the <code>h2</code> tag, then for the <code>a</code> tag, then grab all the text. The tags are to the left of the double colons, what you want to grab is to the right. This is the beauty of Scrapy, it parses the html file for you so you don&#8217;t have to make long regex or other&nbsp;lookups.</p>
<p>Then it&#8217;s as simple as making a loop to loop through all the <code>article</code> tags identified as an&nbsp;entry-list.</p>
<p>Here&#8217;s the&nbsp;boilerplate.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">scrapy</span>

<span class="k">class</span> <span class="nc">BrickSetSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
    
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;ekurd_spider&#39;</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;http://ekurd.net/all-news&#39;</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is our main html parser.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># We set the base tag we&#39;re going to search through for our data</span>
        <span class="n">SET_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;.entry-list&#39;</span>
        
        <span class="c1"># Then iterate through the base tag to get the data we need</span>
        <span class="k">for</span> <span class="n">news</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="n">SET_SELECTOR</span><span class="p">):</span>
            
            <span class="c1"># We define each variable according to its heirarchy</span>
            <span class="c1"># Ex: The DATE_SELECTOR variable would read: </span>
            <span class="c1">#     under the aside tag look for the a tag then look for the time tag and grab the text</span>
            <span class="n">DATE_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;aside a time::text&#39;</span>  
            <span class="n">TITLE_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;h2 a ::text&#39;</span>
            <span class="n">DESCRIP_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;p ::text&#39;</span>
            
            <span class="c1"># We can also grab other non-text elements within tags, like href (urls)</span>
            <span class="n">URL_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;h2 a ::attr(href)&#39;</span> 
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To run a scrapy spider&nbsp;type:</p>
<p><code>scrapy runspider spider.py</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Right now this script just goes crawls over the webpage we provided, saves and rewrites variables. But we need it to save the data in a structured&nbsp;way.</p>
<p>An easy way to save this data is to capture each variable into a list, then toss it into a Pandas dataframe.
We can do this by defining an empty dataframe when we initialize the spider along with several empty lists (one per variable) that we&#8217;ll use to fill in the Pandas&nbsp;dataframe.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">BrickSetSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;ekurd_spider&#39;</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;http://ekurd.net/all-news&#39;</span><span class="p">]</span>

    <span class="c1"># Here we can initialize the script</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    
        <span class="c1"># Create an empty Pandas dataframe, and an empty list per variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">titles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descrips</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urls</span> <span class="o">=</span> <span class="p">[]</span>


    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>

        <span class="n">SET_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;.entry-list&#39;</span>
        
        <span class="k">for</span> <span class="n">news</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="n">SET_SELECTOR</span><span class="p">):</span>

            <span class="n">DATE_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;aside a time::text&#39;</span>
            <span class="n">TITLE_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;h2 a ::text&#39;</span>
            <span class="n">DESCRIP_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;p ::text&#39;</span>
            <span class="n">URL_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;h2 a ::attr(href)&#39;</span>

            <span class="c1"># We extract the data from each variable and save it in the corresponding list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">news</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="n">DATE_SELECTOR</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">news</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="n">TITLE_SELECTOR</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">descrips</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">news</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="n">DESCRIP_SELECTOR</span><span class="p">)</span><span class="o">.</span><span class="n">extract_first</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">news</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="n">URL_SELECTOR</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
        
        <span class="c1"># Once the lists are complete (the entire page has been scraped) we save it to</span>
        <span class="c1"># a temporary dataframe (out2) that will be later concatenated with our main dataframe (out)</span>
        
        <span class="c1"># Create the temporary dataframe</span>
        <span class="n">out2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">])</span>
        
        <span class="c1"># Save each list to the dataframe</span>
        <span class="n">out2</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dates</span>
        <span class="n">out2</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">titles</span>
        <span class="n">out2</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descrips</span>
        <span class="n">out2</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urls</span>
        
        <span class="c1"># Ensure type is string (useful to bypass any non properly formatted date time and other possible errors)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">out2</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">out2</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">out2</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        
        <span class="c1"># Merge it with our main dataframe (out)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">,</span> <span class="n">out2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Save it to file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;data/test.csv&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now you have a fully functioning spider! But it only scrapes the first page. We need it to iterate through all those next buttons to grab the entire&nbsp;database.</p>
<p>Right click on the next button at the bottom of the page. For this site, the next button looks like two carets <code>&gt;&gt;</code>.</p>
<p><img src="{filename}/images/next_nav.png" alt="Drawing" style="width: 700px;"/></p>
<p>We can see in the source code that the next button is defined in an a tag where the class equals <code>nextpostslink</code>. To use this info we can set a variable <code>NEXT_PAGE_SELECTOR</code> to grab the&nbsp;link.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">NEXT_PAGE_SELECTOR</span> <span class="o">=</span> <span class="s2">&quot;//a[@class=&#39;nextpostslink&#39;]/@href&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note, the syntax for this variable is a bit different that what we used previously to grab a link because I wanted to demonstrate one more way to do this. This method uses the <code>xpath</code> syntax, which is super useful and often used in the forums so its good to be aware of. Basically, this can be read as, the <code>//</code> are the relative path in the html hierarchy to the a tag that has a class of <code>nextpostslink</code> that we want to grab the <code>href</code> (url) from. It comes in handy when you need to traverse html&nbsp;hierarchies.</p>
<p>Once we have defined where the url to the next page lives in the source code, we can make a little conditional yield loop so that while there is a next page url on the webpage we want our spider to click it, go to the next page, and scrape the data (remember, we&#8217;re going to have our spider crawl through many webpages and the very last page won&#8217;t have a next&nbsp;button).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">BrickSetSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;ekurd_spider&#39;</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;http://ekurd.net/all-news&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">titles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descrips</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urls</span> <span class="o">=</span> <span class="p">[]</span>


    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>

        <span class="n">SET_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;.entry-list&#39;</span>
        
        <span class="c1"># We define our link to the next page</span>
        <span class="n">NEXT_PAGE_SELECTOR</span> <span class="o">=</span> <span class="s2">&quot;//a[@class=&#39;nextpostslink&#39;]/@href&quot;</span>
        <span class="c1"># We extract the link using xpath</span>
        <span class="n">next_page</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">NEXT_PAGE_SELECTOR</span><span class="p">)</span><span class="o">.</span><span class="n">extract_first</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">news</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="n">SET_SELECTOR</span><span class="p">):</span>

            <span class="n">DATE_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;aside a time::text&#39;</span>
            <span class="n">TITLE_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;h2 a ::text&#39;</span>
            <span class="n">DESCRIP_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;p ::text&#39;</span>
            <span class="n">URL_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;h2 a ::attr(href)&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">news</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="n">DATE_SELECTOR</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">news</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="n">TITLE_SELECTOR</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">descrips</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">news</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="n">DESCRIP_SELECTOR</span><span class="p">)</span><span class="o">.</span><span class="n">extract_first</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">news</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="n">URL_SELECTOR</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
        
        <span class="c1"># We put a conditional if there is a next page url then rerun the parser</span>
        <span class="k">if</span> <span class="n">next_page</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span>
                <span class="n">response</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">next_page</span><span class="p">),</span>
                <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse</span>
            <span class="p">)</span>

        <span class="n">out2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">])</span>

        <span class="n">out2</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dates</span>
        <span class="n">out2</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">titles</span>
        <span class="n">out2</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descrips</span>
        <span class="n">out2</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urls</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">out2</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">out2</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">out2</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">,</span> <span class="n">out2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;data/test.csv&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And that&#8217;s it! This should crawl through EKurd and scrape the data we&#8217;re looking&nbsp;for.</p>
<p>To adapt this code for other similarly structured sites you only need to&nbsp;change:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;http://ekurd.net/all-news&#39;</span><span class="p">]</span>
<span class="n">SET_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;.entry-list&#39;</span>
<span class="n">NEXT_PAGE_SELECTOR</span> <span class="o">=</span> <span class="s2">&quot;//a[@class=&#39;nextpostslink&#39;]/@href&quot;</span>
<span class="n">DATE_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;aside a time::text&#39;</span>
<span class="n">TITLE_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;h2 a ::text&#39;</span>
<span class="n">DESCRIP_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;p ::text&#39;</span>
<span class="n">URL_SELECTOR</span> <span class="o">=</span> <span class="s1">&#39;h2 a ::attr(href)&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To get a much more in depth and awesome run down of Scrapy check out this post at <a href="https://www.digitalocean.com/community/tutorials/how-to-crawl-a-web-page-with-scrapy-and-python-3">Digital Ocean.</a>
<br><br><br><br></p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
 


<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = '//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: 'center'," +
        "    displayIndent: '0em'," +
        "    showMathMenu: true," +
        "    tex2jax: { " +
        "        inlineMath: [ ['$','$'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        " linebreaks: { automatic: true, width: '95% container' }, " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }" +
        "    } " +
        "}); ";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>

            </div>
            <!-- /.entry-content -->

        </article>
    </section>

        </div>
        <!--         <div class="col-sm-3" id="sidebar">
            <aside>
            </aside>
        </div>
 -->
    </div>
</div>


<footer>
   <div class="well well-lg" id="footer-well">
      <div class="container">
      <div class="row">

             <div class="col-sm-4">
                    <h3>Connect</h3>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                      <ul class="list-group" id="social" style="list-style:none; padding-left:0;">
                        <li class="list-group-item"><a href="https://www.linkedin.com/in/vinnyr/"><i class="fa fa-linkedin-square fa-lg"></i>  LinkedIn</a></li>
                        <li class="list-group-item"><a href="https://twitter.com/vinnyricciardi"><i class="fa fa-twitter-square fa-lg"></i>  Twitter</a></li>
                        <li class="list-group-item"><a href="https://github.com/vinnyricciardi/"><i class="fa fa-github-square fa-lg"></i>  GitHub</a></li>
                        <li class="list-group-item"><a href="https://www.researchgate.net/profile/Vincent_Ricciardi"><i class="fa fa-user fa-lg"></i>  Research Gate</a></li>
                        <li class="list-group-item"><a href="mailto:vinnyricciardi@gmail.com"><i class="fa fa-coffee fa-lg"></i>  Email</a></li>
                      </ul>
                    </li>
              </ul>
            </div>

           <div class="col-sm-4">
               <h3 style="margin-bottom:0.5px;">Research Affiliations</h3>
               </br></br>
               <ul style="list-style:none; padding-left:0;">
                <div style="margin-bottom: 10.5px; margin-top: 10.5px; font-size: 15px;">
                  <li >
                    <a href="http://www.ramankuttylab.com/" target="_blank">
                        Ramankutty Lab
                    </a>
                  </li>
                <div>
                <div style="margin-bottom: 10.5px; margin-top: 10.5px; font-size: 15px;">
                  <li >
                    <a href="http://ires.ubc.ca/" target="_blank">
                        Institute for Resources, Environment, and Sustainability
                    </a>
                  </li>
                <div>
                <div style="margin-bottom: 10.5px; margin-top: 10.5px; font-size: 15px;">
                  <li >
                    <a href="http://liu.arts.ubc.ca/" target="_blank">
                        Liu Institute for Global Issues
                    </a>
                  </li>
                <div>
                <div style="margin-bottom: 10.5px; margin-top: 10.5px; font-size: 15px;">
                  <li >
                    <a href="https://www.grad.ubc.ca/psi" target="_blank">
                        Public Scholars Initiative
                    </a>
                  </li>
                <div>
                <div style="margin-bottom: 10.5px; margin-top: 10.5px; font-size: 15px;">
                  <li >
                    <a href="http://alephpolicy.org/" target="_blank">
                        Aleph Policy Iniative
                    </a>
                  </li>
                <div>
                <div style="margin-bottom: 10.5px; margin-top: 10.5px; font-size: 15px;">
                  <li >
                    <a href="https://ceres2030.org/" target="_blank">
                        Ceres2030
                    </a>
                  </li>
                <div>
              </ul>
             <!-- // <script src="https://apis.google.com/js/platform.js" async defer></script> -->
              <!-- <g:plusone size="standard(bubble)" data-href="http://the-data-show.com"></g:plusone> -->
              <br>
              <h3></h3>
                <div class="addthis_toolbox addthis_default_style addthis_32x32_style" addthis:url="../.." addthis:title="Check out DISHING DATA!">
                  <a class="addthis_button_facebook"></a>
                  <a class="addthis_button_twitter"></a>
                  <a class="addthis_button_email"></a>
                  <a class="addthis_button_linkedin"></a>
                  <a class="addthis_button_compact"></a>
                </div>
                <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid="></script>
           </div>
           <div class="col-sm-4">
<div id="aboutme" align="center">
	<h3 style="margin-bottom:0.5px;">About Vinny Ricciardi</h3><br/>
        <p>
            <img width="60%" class="img-thumbnail" src="../../images/headshot.png"/>
        </p>
    <p> 
        
            Vinny Ricciardi is a PhD Candidate of<br>
            Resource Management & Environmental Studies<br>
            at the University of British Columbia.<br><br>
            
    </p>
</div>
           </div>
      <div class="row">
         <div class="col-xs-10">&copy; 2019 Vinny Ricciardi
            &middot; Powered by <a href="http://python.org/" target="_blank">Python</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            a customized <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            and <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
   </div>
</footer>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="../../theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="../../theme/js/respond.min.js"></script>

<!-- Fix scrolling issues to internal HREFs that get positioned behind navbar -->
<!-- http://stackoverflow.com/questions/10732690/offsetting-an-html-anchor-to-adjust-for-fixed-header -->
<script src="../../theme/js/href_scroll.js"></script>

    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-112689863-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->


</body>
</html>